---
title: Create Page-Level Codebook from `responses.Rdata`
output: html_notebook
---

The purpose of this script is to make a page-level codebook (eventually called `codebook_page`) from `responses.Rdata` that will do the following: 

1. In `responses`, `page` variable is a string that includes both the chapter and page number (e.g., 10.4 represents chapter 10, page 4) and descriptive text. This codebook will have variables called `chapter_num` and `page_num` that each only include one number (e.g., `chapter_num` will be 10 and `page_num` will be 4).
2. Create `responses_nosurvey` which is a responses data file that does not include survey responses and does not include pages that are not within a chapter
3. Create a `codebook_ckcode` with the count of ckcode exercises per page.
4. Create a `codebook_lrn` with the count of auto-scored Learnosity questions per page.
5. Merge all page-level codebooks (e.g., `codebook_ckcode`, `codebook_lrn`) into `codebook_page`

## Set up and load `responses.Rdata`

```{r}
# load libraries
library(mosaic)
library(dplyr)
library(tidyverse)
library(ggplot2)

# start with raw data from responses.Rdata
load("../raw/responses.Rdata")

# there should be no duplicates but just in case, this removes duplicate rows
responses_all <- distinct(responses)
```

## 1. Create page_num and chapter_num variables

```{r}
# make a data frame where each row is a page
codebook_page_temp <- responses %>%
  select(book, chapter, page, release) %>%
  unique() %>%
  mutate(chapter_num = as.numeric(gsub("\\D", "", chapter)),
         page_string = str_extract(str_trunc(page, 8, "right"), "\\d+\\.*\\d*"),
         page_num_from_string = as.numeric(str_extract(str_trunc(page, 8, "right"), "\\d+\\.*\\d*")),
         temp_page_within_ch = round((page_num_from_string - chapter_num)/10,3),
         is_10 = grepl(".10", page_string, fixed = TRUE),
         is_between_10_20 = temp_page_within_ch > .010 & temp_page_within_ch < .019,
         page_within_ch = ifelse(is_10 | is_between_10_20, temp_page_within_ch*10, temp_page_within_ch)) %>%
  select(book, release, chapter, page, chapter_num, page_within_ch) %>% 
  mutate(page_num = page_within_ch*100) %>%
  filter(!is.na(page_num))

```

## 2. Create responses_nosurvey data frame

This data frame has these features:
- chapter_num, page_num included
- remove survey responses
- removes responses from pages that are not within a chapter
- removes extra variables that are not frequently used

Read in survey codebook so we can filter out survey responses.

```{r}
codebook_all_surveys <- read.csv("../codebooks/codebook_all_surveys.csv")
```

```{r}
responses_nosurvey <- responses %>%
  left_join(codebook_page_temp, by=c("book", "release", "chapter", "page"))

responses_nosurvey <- responses_nosurvey[, c("student_id", "class_id", "item_id", "lrn_question_reference", "item_type", "chapter_num", "page_num", "completes_page", "response", "points_possible", "points_earned", "lrn_status", "lrn_type", "attempt", "lrn_dt_started", "lrn_dt_saved", "dt_submitted", "book", "release")] %>%
  filter(!(item_id %in% codebook_all_surveys$item_id)) %>%
  filter(!(is.na(page_num)))
```

## 3. Create codebook_ckcode with number of CK codes per page

```{r}
codebook_ckcode <- responses_nosurvey %>%
  filter(item_type == "code") %>%
  group_by(book, release, chapter_num, page_num) %>%
  mutate(n_code = length(unique(item_id))) %>%
  select(book, release, chapter_num, page_num, n_code) %>%
  distinct() 
```

## 4. Create codebook_lrn with number of auto-scored learnosity questions per page

```{r}

lrn_types <- c("mcq", "choicematrix", "shorttext", "plaintext", "clozeassociation", "association","imageclozeassociation",
  "sortlist","formulaV2")

lrn_types_auto <- c("mcq", "clozeassociation", "association","imageclozeassociation",
  "sortlist","formulaV2")

```

Focus solely on responses from learnosity questions.

```{r}
responses_lrn <- responses_nosurvey %>%
  filter(item_type != "code") 
```

```{r}
# create temporary codebook for learnosity
codebook_lrn <- responses_lrn %>%
  group_by(book, release, chapter_num, page_num) %>%
  mutate(n_lrn_q = length(unique(lrn_question_reference)),
         n_lrn_item = length(unique(item_id))) %>%
  select(book, release, chapter_num, page_num, n_lrn_q, n_lrn_item) %>%
  distinct() 
```

```{r}
# get counts of all learnosity types
codebook_lrn_type_long <- responses_lrn %>%
  group_by(book, release, chapter_num, page_num, lrn_type) %>%
  mutate(n_lrn_q_per_type = length(unique(lrn_question_reference))) %>%
  select(book, release, chapter_num, page_num, lrn_type, n_lrn_q_per_type) %>%
  distinct() 
```

```{r}
codebook_lrn_type_wide <- 
  codebook_lrn_type_long %>%
  filter(lrn_type %in% lrn_types) %>%
  pivot_wider(names_from = lrn_type, values_from = n_lrn_q_per_type) %>%
  distinct() 
  #head()

codebook_lrn_type_wide[is.na(codebook_lrn_type_wide)] <- 0

codebook_lrn_type_wide <- codebook_lrn_type_wide %>%
  mutate(lrn_auto = mcq + association + shorttext + clozeassociation + imageclozeassociation + sortlist + formulaV2)
```

```{r}
codebook_lrn_with_types <- codebook_lrn %>%
  left_join(codebook_lrn_type_wide, by = c("book", "release", "chapter_num", "page_num")) %>%
  select(book, release, chapter_num, page_num, n_lrn_q, n_lrn_item, lrn_auto, mcq, association, shorttext, clozeassociation, imageclozeassociation, sortlist, formulaV2, choicematrix, plaintext)
```

## 5. Merge all page level codebooks and write a csv file called `codebook_page.csv`

```{r}

codebook_page <- codebook_page_temp %>%
  left_join(codebook_ckcode, by = c("book", "release", "chapter_num", "page_num")) %>%
  left_join(codebook_lrn_with_types, by = c("book", "release", "chapter_num", "page_num")) 

write.csv(codebook_page, "../codebooks/codebook_page.csv")

```

```{r}
# remove temporary datafiles
rm(responses_lrn, codebook_lrn, codebook_lrn_type_long, codebook_lrn_type_wide)
rm(codebook_ckcode, codebook_lrn_with_types, codebook_page_temp)
```

