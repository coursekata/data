---
title: "Coding Exercises"
output: html_notebook
---

The purpose of this script is to produce two data files:

1. `student_page_code.RData`
  - each row is a unique `student_id`+`class_id`+`chapter_num`+`page_num`
  - note that each class only uses one `book` with a particular `release`
2. `student_ch_code.RData`
  - each row is a unique combination of `student_id`+`class_id`+`chapter_num`
  
These data files include ckcode (coding exercises) metrics such as: 
- attempts
- correctness ever (were any attempts correct?)
- correctness first try (was first attempt correct?)

## Set up

```{r}
# load relevant libraries
library(tidyverse)
library(mosaic)

# start with raw data from responses.Rdata
load("../raw/responses.Rdata")
responses_all <- responses

# load all codebooks
codebook_all_surveys <- read.csv("../codebooks/codebook_all_surveys.csv")
codebook_page <- read.csv("../codebooks/codebook_page.csv")
codebook_chapter <- read.csv("../codebooks/codebook_chapter.csv")
```

- Merge variables `page_num` and `chapter_num` into `responses`. 
- Filter out any survey responses.
- Filter for coding responses only.

```{r}
responses_code <- responses %>%
  left_join(codebook_page, by=c("book", "release", "chapter", "page")) %>%
  select("book", "release", "class_id", "student_id", "item_id", 
         "item_type", "chapter_num", "page_num", "completes_page", "response", 
         "points_possible", "points_earned", "attempt", "dt_submitted") %>%
  filter(!(item_id %in% codebook_all_surveys$item_id)) %>%
  filter(!(is.na(page_num))) %>%
  filter(item_type=="code") 

```

# Create `student_code`, a temporary data set

In `student_code`, each row is a `student_id`+`class_id`+`item_id`. We will use it to make page and chapter-level data.

```{r}

student_code <- responses_code %>%
  group_by(book, release, student_id, class_id, item_id, chapter_num, page_num) %>%
  mutate(is_correct_ever = max(points_earned), 
         correct_first_try = ifelse(attempt == 1, points_earned, NA),
         n_attempts = max(attempt),
         n_correct = sum(points_earned, na.rm=TRUE)) %>%
  select(book, release, class_id, student_id, chapter_num, page_num, item_id, item_type,
         is_correct_ever, correct_first_try, n_attempts, n_correct) %>%
  filter(!is.na(page_num)) %>% 
  filter(!is.na(correct_first_try)) %>% 
  distinct()

```

## 1. Create `student_page_code`

Each row is a `student_id`+`class_id`+`chapter_num`+`page_num`.

Contains variables:
- `n_correct_ever_pg` per page, how many coding exercises were answered correctly (on any attempt); this number is equal to or less than the number of coding exercises on the page
- `n_correct_first_try_pg` per page, how many coding exercises were answered correctly on first attempt (`attempt == 1`)?
- `n_attempts_pg` per page, how many attempts total on coding exercises?
- `n_correct_attempts_pg` per page, how many correct attempts on coding exercises? (this number may be higher than the number of coding exercises on the page)
- `prop_correct_ever_pg` per page, proportion of correctly answered coding exercises (on any attempt); cannot be greater than 1
- `prop_correct_first_try_pg` per page, proportion of correctly answered coding exercises on first attempt; cannot be greater than 1
- `attempt_per_code_pg` per page, number of attempts per coding exercise (possible to be less than or greater than 1)

```{r}
student_page_code <- student_code %>%
  group_by(student_id, class_id, chapter_num, page_num) %>%
  mutate(n_correct_ever_pg = sum(is_correct_ever, na.rm=TRUE), 
         n_correct_first_try_pg = sum(correct_first_try, na.rm=TRUE),
         n_attempts_pg = sum(n_attempts, na.rm=TRUE),
         n_correct_attempts_pg = sum(n_correct, na.rm=TRUE)) %>%
  select(book, release, class_id, student_id, chapter_num, page_num,  
         n_correct_ever_pg, n_correct_first_try_pg, 
         n_attempts_pg, n_correct_attempts_pg) %>%
  distinct() %>%
  left_join(codebook_page, by=c('book', 'release', 'chapter_num', 'page_num')) %>%
  mutate(prop_correct_ever_pg = n_correct_ever_pg / n_code, 
         prop_correct_first_try_pg = n_correct_first_try_pg / n_code, 
         attempt_per_code_pg = n_attempts_pg / n_code) %>%
  select(book, release, class_id, student_id, chapter_num, page_num,  
         n_correct_ever_pg, n_correct_first_try_pg, n_attempts_pg, n_correct_attempts_pg,
         prop_correct_ever_pg, prop_correct_first_try_pg, attempt_per_code_pg)   

```

Check that these are not greater than 1:
- `prop_correct_ever_pg` 
- `prop_correct_first_try_pg` 

```{r}
favstats(~ prop_correct_ever_pg, data = student_page_code)
favstats(~ prop_correct_first_try_pg, data = student_page_code)
```

```{r}
save(student_page_code, file = "../level-page/student_page_code.Rdata", compress = "xz", compression_level = 9)
```

##  2. Create `student_chapter_code`

Each row is a `student_id`+`class_id`+`chapter_num`.

Contains variables:
- `n_correct_ever_ch` per chapter, how many coding exercises were answered correctly (on any attempt); this number is equal to or less than the number of coding exercises in the chapter
- `n_correct_first_try_ch` per chapter, how many coding exercises were answered correctly on first attempt (`attempt == 1`)?
- `n_attempts_ch` per chapter, how many attempts total on coding exercises?
- `n_correct_attempts_ch` per chapter, how many correct attempts on coding exercises? (this number may be higher than the number of coding exercises in the chapter)
- `prop_correct_ever_ch` per chapter, proportion of correctly answered coding exercises (on any attempt); cannot be greater than 1
- `prop_correct_first_try_ch` per chapter, proportion of correctly answered coding exercises on first attempt; cannot be greater than 1

```{r}
student_chapter_code <- student_page_code %>%
  group_by(student_id, class_id, chapter_num) %>%
  mutate(n_correct_ever_ch = sum(n_correct_ever_pg, na.rm=TRUE),
         n_correct_first_try_ch = sum(n_correct_first_try_pg, na.rm=TRUE),
         n_attempts_ch = sum(n_attempts_pg, na.rm=TRUE),
         n_correct_attempts_ch = sum(n_correct_attempts_pg, na.rm=TRUE)) %>%
  left_join(codebook_chapter, by = c("book", "release", "chapter_num")) %>%
  mutate(prop_correct_ever_ch = n_correct_ever_ch / n_code, 
         prop_correct_first_try_ch = n_correct_first_try_ch / n_code) %>% 
  select(book, release, class_id, student_id, chapter_num, 
         n_correct_ever_ch, n_correct_first_try_ch, n_attempts_ch, n_correct_attempts_ch,
         prop_correct_ever_ch, prop_correct_first_try_ch) %>%
  distinct()

```

Sanity checks:
- prop_correct_first_try_ch <= prop_correct_ever_ch
- proportions cannot be greater than 1

```{r}
tally(~ prop_correct_first_try_ch <= prop_correct_ever_ch, data = student_chapter_code)
favstats(~ prop_correct_first_try_ch, data = student_chapter_code)
favstats(~ prop_correct_ever_ch, data = student_chapter_code)
```

```{r}
save(student_chapter_code, file = "../level-chapter/student_ch_code.Rdata", compress = "xz", compression_level = 9)

```



